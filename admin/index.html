<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Painel Administrativo • Sumaúma Pesquisas</title>
    <link rel="stylesheet" href="./admin.css" />
  </head>
  <body>
    <div class="admin-shell">
      <header class="admin-header">
        <div>
          <strong>Painel Administrativo</strong>
          <span class="muted">Portal multi-pesquisas</span>
        </div>
        <div class="admin-actions">
          <span id="admin-user" class="muted"></span>
          <button id="btn-logout" class="btn light" type="button">Sair</button>
        </div>
      </header>

      <main class="admin-main">
        <section id="login-panel" class="card">
          <h2>Entrar</h2>
          <p class="muted">Use o e-mail e senha cadastrados no Supabase Auth.</p>
          <form id="login-form">
            <label>
              Email
              <input type="email" name="email" required />
            </label>
            <label>
              Senha
              <input type="password" name="password" required />
            </label>
            <button class="btn primary" type="submit">Entrar</button>
          </form>
          <p id="login-error" class="error"></p>
        </section>

        <section id="admin-panel" class="hidden">
          <!-- Abas principais (fora do editar pesquisa) -->
          <div class="main-tabs" id="main-tabs">
            <button class="main-tab active" type="button" id="mainTabPesquisas" data-main-tab="pesquisas">Pesquisas</button>
            <button class="main-tab" type="button" id="mainTabSite" data-main-tab="site">Site</button>
          </div>

          <!-- PAINEL: PESQUISAS -->
          <section id="mainPanelPesquisas" class="admin-grid" data-main-panel="pesquisas">
            <aside class="admin-sidebar">
            <div class="sidebar-head">
              <button id="btn-new" class="btn primary" type="button">Nova pesquisa</button>
              <div class="side-title">Pesquisas cadastradas</div>
            </div>
            <div id="researchList" class="research-list"></div>
            <div id="researchListMsg" class="small muted"></div>
            </aside>

            <section class="admin-editor">
            <form id="pesquisa-form" class="card hidden">
              <div class="form-head">
                <div>
                  <h2 id="form-title">Nova pesquisa</h2>
                  <p class="muted">Preencha os dados base e edite as abas de conteúdo.</p>
                </div>
                <div class="form-actions">
                  <button id="btn-delete" class="btn danger" type="button">Excluir</button>
                  <button id="btnSalvar" class="btn primary" type="button">Salvar</button>
                </div>
                <div id="adminMsg" class="admin-msg"></div>
              </div>
              <div id="saveAlert" style="margin-top:10px;display:none;padding:10px 12px;border-radius:12px;font-size:13px;"></div>
              <details id="saveDetails" style="margin-top:8px;display:none;">
                <summary style="cursor:pointer;font-size:12px;color:#6b7a75;">Ver detalhes técnicos</summary>
                <pre id="saveDebug" style="margin-top:8px;background:#fff;border:1px solid rgba(0,0,0,.1);padding:10px;border-radius:12px;white-space:pre-wrap;word-break:break-word;font-size:12px;"></pre>
              </details>
              <div id="saveMsg" class="small muted"></div>

              <div class="tabs" id="editor-tabs">
                <button class="tab active" type="button" data-tab="config">Configuração</button>
                <button class="tab" type="button" data-tab="resumo">Pesquisa</button>
                <button class="tab" type="button" data-tab="ficha">Ficha Técnica</button>
                <button class="tab" type="button" data-tab="mapa">Mapa</button>
              </div>

              <div class="tab-panel" data-tab-panel="config">
                <h3>Configuração</h3>
                <div class="grid-2">
                  <label>
                    Slug
                    <input type="text" name="slug" required />
                  </label>
                  <label>
                    Título
                    <input type="text" name="titulo" required />
                  </label>
                  <label>
                    Ano base
                    <input type="text" name="anoBase" />
                  </label>
                  <label>
                    Ordem
                    <input type="number" name="ordem" min="0" step="1" />
                  </label>
                  <label>
                    Status
                    <select name="status">
                      <option value="true">Publicado</option>
                      <option value="false">Rascunho</option>
                    </select>
                  </label>
                  <label>
                    Descrição curta
                    <textarea name="descricaoCurta" rows="2"></textarea>
                  </label>
                  <label>
                    Sinopse (relatório)
                    <textarea name="sinopse" rows="2"></textarea>
                  </label>
                </div>

                <div class="upload-row">
                  <div>
                    <label>Capa</label>
                    <input type="file" name="capaFile" accept="image/*" />
                    <img id="capa-preview" class="preview" alt="Prévia da capa" />
                  </div>
                  <div>
                    <label>Relatório PDF</label>
                    <input type="file" name="relatorioFile" accept="application/pdf" />
                    <label>
                      URL de leitura (opcional)
                      <input type="text" name="relatorioLeituraUrl" placeholder="https://..." />
                    </label>
                  </div>
                </div>

                <div class="card" style="margin-top:12px;">
                  <h4 style="margin:0 0 6px;">Banner do topo (desta pesquisa)</h4>
                  <p class="muted" style="margin:0 0 10px;">
                    Esse banner aparece no topo quando a pessoa entra nesta pesquisa publicada (no cabeçalho).
                  </p>
                  <div class="grid-2">
                    <div class="row">
                      <label class="label">Upload do banner (PNG/JPG)</label>
                      <input id="pesquisaBannerFile" type="file" accept="image/*" />
                    </div>
                    <div class="row">
                      <label class="label">URL do banner (opcional)</label>
                      <input id="pesquisaBannerUrl" type="text" class="field" placeholder="https://..." />
                    </div>
                    <div class="row">
                      <label class="label">Crédito do banner (opcional)</label>
                      <input name="bannerCredito" type="text" class="field" placeholder="Ex.: Foto: Fulano de Tal" />
                    </div>
                  </div>
                  <div
                    class="row"
                    style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px;"
                  >
                    <button id="btnSavePesquisaBanner" class="btn primary" type="button">
                      Salvar banner desta pesquisa
                    </button>
                    <span id="pesquisaBannerMsg" class="muted"></span>
                  </div>
                  <img id="pesquisaBannerPreview" class="preview" alt="Prévia banner da Pesquisa" />
                </div>

                <input type="hidden" name="csvUrl" />
                <input type="hidden" name="capaUrl" />
                <input type="hidden" name="relatorioUrl" />
              </div>

              <div class="tab-panel hidden" data-tab-panel="resumo">
                <h3>Pesquisa</h3>
                <div class="grid-2">
                  <label>
                    Resumo
                    <textarea name="resumo" rows="3"></textarea>
                  </label>
                  <label>
                    Título da introdução
                    <input type="text" name="introTitulo" />
                  </label>
                  <label>
                    Texto da introdução
                    <textarea name="introTexto" rows="3"></textarea>
                  </label>
                  <label>
                    Texto da citação
                    <textarea name="citacaoTexto" rows="2"></textarea>
                  </label>
                  <label>
                    Autor da citação
                    <input type="text" name="citacaoAutor" />
                  </label>
                </div>

                <div class="repeater">
                  <div class="repeater-head">
                    <h4>Tópicos</h4>
                    <button id="add-topico" class="btn light" type="button">Adicionar tópico</button>
                  </div>
                  <div id="topicos-list" class="repeater-list"></div>
                </div>
              </div>

              <div class="tab-panel hidden" data-tab-panel="ficha">
                <h3>Ficha técnica</h3>
                <div class="grid-2">
                  <label>
                    Realização
                    <input type="text" name="realizacaoNome" />
                  </label>
                  <label>
                    Financiamento
                    <input type="text" name="financiadorNome" />
                  </label>
                  <label>
                    Logo realização
                    <input type="file" name="realizacaoLogoFile" accept="image/*" />
                  </label>
                  <label>
                    Logo financiamento
                    <input type="file" name="financiadorLogoFile" accept="image/*" />
                  </label>
                </div>
                <input type="hidden" name="realizacaoLogoUrl" />
                <input type="hidden" name="financiadorLogoUrl" />

                <div class="grid-2">
                  <label>
                    Coordenação
                    <textarea name="coordenacao" rows="2"></textarea>
                  </label>
                  <label>
                    Parceiros / apoiadores
                    <textarea name="parceirosApoiadores" rows="2"></textarea>
                  </label>
                </div>

                <div class="repeater">
                  <div class="repeater-head">
                    <h4>Equipe</h4>
                    <button id="add-equipe" class="btn light" type="button">Adicionar membro</button>
                  </div>
  
                  <label style="display:block; margin:10px 0 14px;">
                    Texto da equipe (breve explicação + instrução de clique)
                    <textarea name="equipeTexto" rows="3" placeholder="Ex.: Esta pesquisa foi construída por uma equipe diversa... Para conhecer o trabalho de cada integrante ou entrar em contato, clique no card da pessoa ou no botão de link."></textarea>
                  </label>
  
                  <div id="equipe-list" class="repeater-list"></div>
                </div>
              </div>

              <div class="tab-panel hidden" data-tab-panel="mapa">
                <div class="pontos-head">
                  <h3>Mapa</h3>
                </div>
                <div id="mapa-update-card" class="card" style="margin:12px 0; padding:12px;">
                  <div style="display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;">
                    <div>
                      <h4 style="margin:0 0 6px;">Atualizar mapa (CSV)</h4>
                      <div class="muted" style="font-size:12px; line-height:1.4;">
                        Faça upload do CSV para atualizar os pontos do mapa desta pesquisa.
                        Após selecionar o arquivo, você verá uma prévia e, em seguida, a lista será atualizada.
                      </div>
                      <div id="mapa-update-status" class="muted" style="margin-top:8px; font-size:12px;">Aguardando CSV…</div>
                    </div>

                    <label class="btn primary" style="cursor:pointer;">
                      Selecionar CSV
                      <input id="import-csv" type="file" accept=".csv" hidden />
                    </label>
                  </div>

                  <div style="margin-top:12px;">
                    <div class="muted" style="font-size:12px; margin-bottom:6px;">Prévia do CSV</div>
                    <div id="csv-preview-meta" class="muted" style="font-size:12px;">Nenhum arquivo carregado.</div>
                    <div id="csv-preview-list" style="margin-top:10px; max-height:240px; overflow:auto;"></div>
                  </div>
                </div>
                <div class="pontos-grid">
                  <div>
                    <div class="pontos-toolbar" id="pontos-toolbar">
                      <button id="ponto-new" class="btn primary" type="button">➕ Cadastrar novo</button>
                      <input id="pontos-search" class="field" type="text" placeholder="Buscar ponto por nome, cidade ou categoria..." />
                      <div class="pontos-counter muted" id="pontos-counter">0 pontos</div>
                    </div>
                    <div id="pontos-list" class="pontos-list"></div>
                  </div>
                  <div class="card">
                    <h4 id="ponto-form-title">Novo ponto</h4>
                    <div id="ponto-preview" class="ponto-preview hidden"></div>
                    <form id="ponto-form">
                      <label>Nome<input type="text" name="nome" required /></label>
                      <label>Cidade<input type="text" name="cidade" /></label>
                      <label>UF<input type="text" name="uf" /></label>
                      <label>Categoria<input type="text" name="categoria" /></label>
                      <label>Latitude<input type="number" step="any" name="lat" /></label>
                      <label>Longitude<input type="number" step="any" name="lng" /></label>
                      <label>Descrição<textarea name="descricao" rows="2"></textarea></label>
                      <label>Site<input type="text" name="site" /></label>
                      <label>Instagram<input type="text" name="instagram" /></label>
                      <label>Facebook<input type="text" name="facebook" /></label>
                      <label>WhatsApp<input type="text" name="whatsapp" /></label>
                      <label>Email<input type="text" name="email" /></label>
                      <label>Ativo<select name="ativo"><option value="true">Sim</option><option value="false">Não</option></select></label>
                      <div class="form-actions">
                        <button id="ponto-delete" class="btn danger" type="button">Excluir</button>
                        <button class="btn primary" type="submit">Salvar ponto</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div id="empty-state" class="card">
                <h2>Selecione uma pesquisa</h2>
                <p class="muted">Use a lista ao lado para editar ou crie uma nova pesquisa.</p>
              </div>
            </section>
          </section>

          <!-- PAINEL: SITE (global, fora das pesquisas) -->
          <section id="mainPanelSite" class="hidden" data-main-panel="site">
            <div class="card">
              <h2>Configurações do Site</h2>
              <p class="muted">Essas configurações são globais e independentes das pesquisas.</p>
            </div>

            <div class="grid-2">
              <div class="card">
                <h4>Banner da Home</h4>
                <p class="muted" style="margin-top:-6px;">
                  Este banner aparece na página inicial antes do mapa.
                </p>
                <div class="row">
                  <label class="label">Upload do banner (PNG/JPG)</label>
                  <input id="homeBannerFile" type="file" accept="image/*" />
                </div>
                <div class="row">
                  <label class="label">URL do banner (opcional)</label>
                  <input id="homeBannerUrl" type="text" class="field" placeholder="https://..." />
                </div>
                <div class="row">
                  <button id="btnSaveHomeBanner" class="btn primary" type="button">Salvar banner da Home</button>
                  <span id="homeBannerMsg" class="muted"></span>
                </div>
                <img id="homeBannerPreview" class="preview" alt="Prévia banner da Home" />
              </div>

              <div class="card">
                <h4>Ícone do Site (Favicon)</h4>
                <p class="muted" style="margin-top:-6px">
                  Recomendado: PNG quadrado (ex: 256x256). O site usa automaticamente.
                </p>

                <div class="row">
                  <label class="label">Upload (Storage site-assets)</label>
                  <input id="faviconFile" type="file" accept="image/png,image/x-icon,image/svg+xml,image/*" />
                </div>

                <div class="row">
                  <label class="label">Ou URL direta</label>
                  <input id="faviconUrl" class="field" placeholder="https://..." />
                </div>

                <div class="row">
                  <button id="btnSaveFavicon" class="btn primary" type="button">Salvar favicon</button>
                  <span id="faviconMsg" class="muted"></span>
                </div>

                <div class="preview" style="display:flex;gap:12px;align-items:center">
                  <img id="faviconPreview" alt="Prévia favicon" style="width:48px;height:48px;border-radius:12px;display:none;border:1px solid rgba(0,0,0,.08)" />
                  <small class="muted">Prévia (48px)</small>
                </div>
              </div>

              <div class="card">
                <h4>Logo do Site</h4>
                <p class="muted" style="margin-top:-6px">
                  Logo exibida no cabeçalho público. Envie um arquivo ou informe a URL.
                </p>

                <div class="row">
                  <label class="label">Upload (Storage site-assets)</label>
                  <input id="siteLogoFile" type="file" accept="image/*" />
                </div>

                <div class="row">
                  <label class="label">Ou URL direta</label>
                  <input id="siteLogoUrl" class="field" placeholder="https://..." />
                  <div class="small muted" style="margin-top:6px;">Se enviar um arquivo, a URL será atualizada automaticamente.</div>
                </div>

                <div class="row">
                  <button id="btnSaveSiteLogo" class="btn primary" type="button">Salvar logo</button>
                  <span id="siteLogoMsg" class="muted"></span>
                </div>

                <img id="siteLogoPreview" alt="Prévia do logo" style="max-width:260px;border-radius:12px;display:none;border:1px solid rgba(0,0,0,.08)" />
              </div>
            </div>
          </section>
        </section>
      </main>
    </div>

    <!-- Modal: Editar Ponto -->
    <div class="modal-backdrop hidden" id="pontoModal">
      <div class="modal">
        <div class="modal-head">
          <div>
            <div class="modal-title" id="pontoModalTitle">Editar ponto</div>
            <div class="modal-sub" id="pontoModalSub">Atualize as informações e clique em Salvar.</div>
          </div>
          <button class="btn-mini" id="pontoModalClose" type="button">✕</button>
        </div>

        <div class="modal-body">
          <form id="pontoModalForm" class="form-grid">
            <input type="hidden" id="pontoModalId" />

            <div class="row">
              <label class="label">Nome</label>
              <input class="field" id="pm_nome" />
            </div>

            <div class="row">
              <label class="label">Categoria</label>
              <input class="field" id="pm_categoria" />
            </div>

            <div class="row">
              <label class="label">Território</label>
              <input class="field" id="pm_territorio" />
            </div>

            <div class="row">
              <label class="label">Contato</label>
              <input class="field" id="pm_contato" />
            </div>

            <div class="row">
              <label class="label">Cidade</label>
              <input class="field" id="pm_cidade" />
            </div>

            <div class="row">
              <label class="label">UF</label>
              <input class="field" id="pm_uf" maxlength="2" />
            </div>

            <div class="row">
              <label class="label">Latitude</label>
              <input class="field" id="pm_lat" />
            </div>

            <div class="row">
              <label class="label">Longitude</label>
              <input class="field" id="pm_lng" />
            </div>

            <div class="row">
              <label class="label">Descrição</label>
              <textarea class="field" id="pm_descricao" rows="3"></textarea>
            </div>

            <div class="row">
              <label class="label">Site</label>
              <input class="field" id="pm_site" />
            </div>

            <div class="row">
              <label class="label">Instagram</label>
              <input class="field" id="pm_instagram" />
            </div>

            <div class="row">
              <label class="label">Facebook</label>
              <input class="field" id="pm_facebook" />
            </div>

            <div class="row">
              <label class="label">WhatsApp</label>
              <input class="field" id="pm_whatsapp" />
            </div>

            <div class="row">
              <label class="label">E-mail</label>
              <input class="field" id="pm_email" />
            </div>

            <div class="row">
              <label class="label">Link</label>
              <input class="field" id="pm_link" />
            </div>

            <div class="row">
              <label class="label">Observação</label>
              <textarea class="field" id="pm_observacao" rows="2"></textarea>
            </div>

            <div class="row">
              <label class="label">Ativo</label>
              <select class="field" id="pm_ativo">
                <option value="true">Sim</option>
                <option value="false">Não</option>
              </select>
            </div>
          </form>
        </div>

        <div class="modal-foot">
          <div class="muted" id="pontoModalMsg"></div>
          <div class="modal-actions">
            <button class="btn" id="pontoModalCancel" type="button">Cancelar</button>
            <button class="btn primary" id="pontoModalSave" type="button">Salvar</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const paths = [
          "../js/supabase-config.js",
          "/js/supabase-config.js",
          "../src/js/supabase-config.js"
        ];
        window.__SUPABASE_CONFIG_PATHS__ = paths;

        function loadScript(src) {
          return new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src = src;
            script.onload = () => resolve(src);
            script.onerror = () => reject(new Error(`Falha ao carregar ${src}`));
            document.head.appendChild(script);
          });
        }

        let chain = Promise.reject();
        paths.forEach((src) => {
          chain = chain.catch(() => loadScript(src));
        });

        window.__SUPABASE_CONFIG_LOADED__ = chain
          .then((src) => {
            if (src) {
              console.log("[Supabase] Config carregada:", src);
            }
            return src;
          })
          .catch((error) => {
            console.warn("[Supabase] Nenhum supabase-config.js encontrado.", error);
            return null;
          });
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-client.js"></script>
    <script type="module" src="./admin.js"></script>
  </body>
</html>
