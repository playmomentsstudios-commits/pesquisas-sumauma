<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Painel Administrativo • Sumaúma Pesquisas</title>
    <link rel="stylesheet" href="./admin.css" />
  </head>
  <body>
    <div class="admin-shell">
      <header class="admin-header">
        <div>
          <strong>Painel Administrativo</strong>
          <span class="muted">Portal multi-pesquisas</span>
        </div>
        <div class="admin-actions">
          <span id="admin-user" class="muted"></span>
          <button id="btn-logout" class="btn light" type="button">Sair</button>
        </div>
      </header>

      <main class="admin-main">
        <section id="login-panel" class="card">
          <h2>Entrar</h2>
          <p class="muted">Use o e-mail e senha cadastrados no Supabase Auth.</p>
          <form id="login-form">
            <label>
              Email
              <input type="email" name="email" required />
            </label>
            <label>
              Senha
              <input type="password" name="password" required />
            </label>
            <button class="btn primary" type="submit">Entrar</button>
          </form>
          <p id="login-error" class="error"></p>
        </section>

        <section id="admin-panel" class="admin-grid hidden">
          <aside class="admin-sidebar">
            <div class="sidebar-head">
              <button id="btn-new" class="btn primary" type="button">Nova pesquisa</button>
              <div class="side-title">Pesquisas cadastradas</div>
            </div>
            <div id="researchList" class="research-list"></div>
            <div id="researchListMsg" class="small muted"></div>
          </aside>

          <section class="admin-editor">
            <form id="pesquisa-form" class="card hidden">
              <div class="form-head">
                <div>
                  <h2 id="form-title">Nova pesquisa</h2>
                  <p class="muted">Preencha os dados base e edite as abas de conteúdo.</p>
                </div>
                <div class="form-actions">
                  <button id="btn-delete" class="btn danger" type="button">Excluir</button>
                  <button id="btnSalvar" class="btn primary" type="button">Salvar</button>
                </div>
                <div id="adminMsg" class="admin-msg"></div>
              </div>
              <div id="saveAlert" style="margin-top:10px;display:none;padding:10px 12px;border-radius:12px;font-size:13px;"></div>
              <details id="saveDetails" style="margin-top:8px;display:none;">
                <summary style="cursor:pointer;font-size:12px;color:#6b7a75;">Ver detalhes técnicos</summary>
                <pre id="saveDebug" style="margin-top:8px;background:#fff;border:1px solid rgba(0,0,0,.1);padding:10px;border-radius:12px;white-space:pre-wrap;word-break:break-word;font-size:12px;"></pre>
              </details>
              <div id="saveMsg" class="small muted"></div>

              <div class="grid-2">
                <label>
                  Slug
                  <input type="text" name="slug" required />
                </label>
                <label>
                  Título
                  <input type="text" name="titulo" required />
                </label>
                <label>
                  Ano base
                  <input type="text" name="anoBase" />
                </label>
                <label>
                  Ordem
                  <input type="number" name="ordem" min="0" step="1" />
                </label>
                <label>
                  Descrição curta
                  <textarea name="descricaoCurta" rows="2"></textarea>
                </label>
                <label>
                  Sinopse (relatório)
                  <textarea name="sinopse" rows="2"></textarea>
                </label>
                <label>
                  Status
                  <select name="status">
                    <option value="true">Publicado</option>
                    <option value="false">Rascunho</option>
                  </select>
                </label>
              </div>
              <input type="hidden" name="csvUrl" />
              <input type="hidden" name="capaUrl" />
              <input type="hidden" name="relatorioUrl" />
              <input type="hidden" name="realizacaoLogoUrl" />
              <input type="hidden" name="financiadorLogoUrl" />

              <div class="upload-row">
                <div>
                  <label>Capa</label>
                  <input type="file" name="capaFile" accept="image/*" />
                  <img id="capa-preview" class="preview" alt="Prévia da capa" />
                </div>
                <div>
                  <label>Relatório PDF</label>
                  <input type="file" name="relatorioFile" accept="application/pdf" />
                  <label>
                    URL de leitura (opcional)
                    <input type="text" name="relatorioLeituraUrl" placeholder="https://..." />
                  </label>
                </div>
              </div>

              <div class="tabs">
                <button class="tab active" type="button" data-tab="conteudo">Conteúdo</button>
                <button class="tab" type="button" data-tab="ficha">Ficha técnica</button>
                <button class="tab" type="button" data-tab="relatorio">Relatório</button>
                <button class="tab" type="button" data-tab="pontos">Pontos do mapa</button>
              </div>

              <div class="tab-panel" data-tab-panel="conteudo">
                <h3>Pesquisa (Resumo)</h3>
                <div class="grid-2">
                  <label>
                    Título da introdução
                    <input type="text" name="introTitulo" />
                  </label>
                  <label>
                    Texto da introdução
                    <textarea name="introTexto" rows="3"></textarea>
                  </label>
                  <label>
                    Texto da citação
                    <textarea name="citacaoTexto" rows="2"></textarea>
                  </label>
                  <label>
                    Autor da citação
                    <input type="text" name="citacaoAutor" />
                  </label>
                </div>

                <div class="repeater">
                  <div class="repeater-head">
                    <h4>Tópicos</h4>
                    <button id="add-topico" class="btn light" type="button">Adicionar tópico</button>
                  </div>
                  <div id="topicos-list" class="repeater-list"></div>
                </div>
              </div>

              <div class="tab-panel hidden" data-tab-panel="ficha">
                <h3>Ficha técnica</h3>
                <div class="grid-2">
                  <label>
                    Realização (nome)
                    <input type="text" name="realizacaoNome" />
                  </label>
                  <label>
                    Logo realização
                    <input type="file" name="realizacaoLogoFile" accept="image/*" />
                  </label>
                  <label>
                    Financiador (nome)
                    <input type="text" name="financiadorNome" />
                  </label>
                  <label>
                    Logo financiador
                    <input type="file" name="financiadorLogoFile" accept="image/*" />
                  </label>
                </div>

                <div class="repeater">
                  <div class="repeater-head">
                    <h4>Equipe</h4>
                    <button id="add-equipe" class="btn light" type="button">Adicionar membro</button>
                  </div>
                  <div id="equipe-list" class="repeater-list"></div>
                </div>
              </div>

              <div class="tab-panel hidden" data-tab-panel="relatorio">
                <h3>Relatório</h3>
                <p class="muted">O PDF já é definido no bloco principal. Você pode usar esta aba para conferir os links.</p>
                <div class="grid-2">
                  <label>
                    URL do PDF
                    <input type="text" name="relatorioUrlConfirm" />
                  </label>
                  <label>
                    URL de leitura
                    <input type="text" name="relatorioLeituraUrlConfirm" />
                  </label>
                </div>
              </div>

              <div class="tab-panel hidden" data-tab-panel="pontos">
                <div class="pontos-head">
                  <h3>Pontos do mapa</h3>
                </div>
                <div id="mapa-update-card" class="card" style="margin:12px 0; padding:12px;">
                  <div style="display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;">
                    <div>
                      <h4 style="margin:0 0 6px;">Atualizar mapa (CSV)</h4>
                      <div class="muted" style="font-size:12px; line-height:1.4;">
                        Faça upload do CSV para atualizar os pontos do mapa desta pesquisa.
                        Após selecionar o arquivo, você verá uma prévia e, em seguida, a lista será atualizada.
                      </div>
                      <div id="mapa-update-status" class="muted" style="margin-top:8px; font-size:12px;">Aguardando CSV…</div>
                    </div>

                    <label class="btn primary" style="cursor:pointer;">
                      Selecionar CSV
                      <input id="import-csv" type="file" accept=".csv" hidden />
                    </label>
                  </div>

                  <div style="margin-top:12px;">
                    <div class="muted" style="font-size:12px; margin-bottom:6px;">Prévia do CSV</div>
                    <div id="csv-preview-meta" class="muted" style="font-size:12px;">Nenhum arquivo carregado.</div>
                    <div id="csv-preview-list" style="margin-top:10px; max-height:240px; overflow:auto;"></div>
                  </div>
                </div>
                <div class="pontos-grid">
                  <div>
                    <div id="pontos-list" class="pontos-list"></div>
                  </div>
                  <div class="card">
                    <h4 id="ponto-form-title">Novo ponto</h4>
                    <form id="ponto-form">
                      <label>Nome<input type="text" name="nome" required /></label>
                      <label>Cidade<input type="text" name="cidade" /></label>
                      <label>UF<input type="text" name="uf" /></label>
                      <label>Categoria<input type="text" name="categoria" /></label>
                      <label>Latitude<input type="number" step="any" name="lat" /></label>
                      <label>Longitude<input type="number" step="any" name="lng" /></label>
                      <label>Descrição<textarea name="descricao" rows="2"></textarea></label>
                      <label>Site<input type="text" name="site" /></label>
                      <label>Instagram<input type="text" name="instagram" /></label>
                      <label>Facebook<input type="text" name="facebook" /></label>
                      <label>WhatsApp<input type="text" name="whatsapp" /></label>
                      <label>Email<input type="text" name="email" /></label>
                      <label>Ativo<select name="ativo"><option value="true">Sim</option><option value="false">Não</option></select></label>
                      <div class="form-actions">
                        <button id="ponto-delete" class="btn danger" type="button">Excluir</button>
                        <button class="btn primary" type="submit">Salvar ponto</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </form>

            <div
              id="debugPanel"
              style="margin-top:14px;padding:12px;border:1px solid rgba(0,0,0,.1);border-radius:12px;background:#fff;"
            >
              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <button id="btnDiag" class="btn-mini">Diagnóstico</button>
                <button id="btnWriteTest" class="btn-mini">Teste INSERT/UPDATE</button>
                <span id="diagStatus" style="font-size:12px;color:#6b7a75;"></span>
              </div>
              <pre
                id="diagOut"
                style="margin-top:10px;white-space:pre-wrap;word-break:break-word;font-size:12px;color:#0b2a1f;"
              ></pre>
            </div>

            <div id="empty-state" class="card">
              <h2>Selecione uma pesquisa</h2>
              <p class="muted">Use a lista ao lado para editar ou crie uma nova pesquisa.</p>
            </div>
          </section>
        </section>
      </main>
    </div>

    <script>
      (function () {
        const paths = [
          "../js/supabase-config.js",
          "/js/supabase-config.js",
          "../src/js/supabase-config.js"
        ];
        window.__SUPABASE_CONFIG_PATHS__ = paths;

        function loadScript(src) {
          return new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src = src;
            script.onload = () => resolve(src);
            script.onerror = () => reject(new Error(`Falha ao carregar ${src}`));
            document.head.appendChild(script);
          });
        }

        let chain = Promise.reject();
        paths.forEach((src) => {
          chain = chain.catch(() => loadScript(src));
        });

        window.__SUPABASE_CONFIG_LOADED__ = chain
          .then((src) => {
            if (src) {
              console.log("[Supabase] Config carregada:", src);
            }
            return src;
          })
          .catch((error) => {
            console.warn("[Supabase] Nenhum supabase-config.js encontrado.", error);
            return null;
          });
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-client.js"></script>
    <script type="module" src="./admin.js"></script>
  </body>
</html>
